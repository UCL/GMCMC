#include <CUnit/CUnit.h>
#include <CUnit/Basic.h>
#include <stdlib.h>

#include "src/ode/cvodes.h"

static inline double reldif(double a, double b) {
  double c = fabs(a);
  double d = fabs(b);

  d = fmax(c, d);

  return (d == 0.0) ? 0.0 : fabs(a - b) / d;
}

#define NUM_TIMEPOINTS 100
#define NUM_SPECIES 2

static int rhs(double t, const double * y, double * ydot, const double * params) {
  (void)t;      // Unused

  // Model parameters
  double a = params[0];
  double b = params[1];
  double c = params[2];

  // Model states
  double v = y[0];
  double r = y[1];

  // d/dt(V) = c*(V-(V^3)/3+R)
  ydot[0] = c * (v - ((v*v*v) / 3.0) + r);

  // d/dt(R) = -(V-a+b*R)/c
  ydot[1] = -(v - a + b * r) / c;

  return 0;
}

static const size_t num_timepoints = NUM_TIMEPOINTS,  num_species = NUM_SPECIES, num_real_params = 3;
static const double params[] = { 0.2, 0.2, 3.0, -1.0, 1.0 };
static const double ics[] = { -1.0, 1.0 };
static const cvodes_options options = { .reltol = 1.0e-08, .abstol = 1.0e-08 };

static const double timepoints[] = {
  0.000000000000000, 0.020020020020020, 0.040040040040040, 0.060060060060060, 0.080080080080080, 0.100100100100100, 0.120120120120120, 0.140140140140140, 0.160160160160160, 0.180180180180180,
  0.200200200200200, 0.220220220220220, 0.240240240240240, 0.260260260260260, 0.280280280280280, 0.300300300300300, 0.320320320320320, 0.340340340340340, 0.360360360360360, 0.380380380380380,
  0.400400400400400, 0.420420420420420, 0.440440440440440, 0.460460460460460, 0.480480480480480, 0.500500500500501, 0.520520520520521, 0.540540540540541, 0.560560560560561, 0.580580580580581,
  0.600600600600601, 0.620620620620621, 0.640640640640641, 0.660660660660661, 0.680680680680681, 0.700700700700701, 0.720720720720721, 0.740740740740741, 0.760760760760761, 0.780780780780781,
  0.800800800800801, 0.820820820820821, 0.840840840840841, 0.860860860860861, 0.880880880880881, 0.900900900900901, 0.920920920920921, 0.940940940940941, 0.960960960960961, 0.980980980980981,
  1.001001001001000, 1.021021021021020, 1.041041041041040, 1.061061061061060, 1.081081081081080, 1.101101101101100, 1.121121121121120, 1.141141141141140, 1.161161161161160, 1.181181181181180,
  1.201201201201200, 1.221221221221220, 1.241241241241240, 1.261261261261260, 1.281281281281280, 1.301301301301300, 1.321321321321320, 1.341341341341340, 1.361361361361360, 1.381381381381380,
  1.401401401401400, 1.421421421421420, 1.441441441441440, 1.461461461461460, 1.481481481481480, 1.501501501501500, 1.521521521521520, 1.541541541541540, 1.561561561561560, 1.581581581581580,
  1.601601601601600, 1.621621621621620, 1.641641641641640, 1.661661661661660, 1.681681681681680, 1.701701701701700, 1.721721721721720, 1.741741741741740, 1.761761761761760, 1.781781781781780,
  1.801801801801800, 1.821821821821820, 1.841841841841840, 1.861861861861860, 1.881881881881880, 1.901901901901900, 1.921921921921920, 1.941941941941940, 1.961961961961960, 1.981981981981980
};

double expected_simdata[][NUM_TIMEPOINTS] = {
  { -1.000000000000000, -0.979772850706684, -0.959104200084401, -0.937951381452664, -0.916269353966098, -0.894010237838994, -0.871123010187808, -0.847552949359081, -0.823241461407669, -0.798125397053176,
    -0.772136473281011, -0.745200805517111, -0.717238303038852, -0.688161939859722, -0.657877033634424, -0.626280490363671, -0.593260010485081, -0.558693265407432, -0.522447029285524, -0.484376364482936,
    -0.444323886646493, -0.402119053790818, -0.357577934452873, -0.310503127351830, -0.260684200389472, -0.207898945813645, -0.151915787964895, -0.092497399508787, -0.029406350336368,  0.037586796552647,
     0.108692447454127,  0.184087211377413,  0.263895060261369,  0.348163968785750,  0.436838699268584,  0.529730464493469,  0.626486011274088,  0.726559842505900,  0.829194948396618,  0.933418016133602,
     1.038056144762867,  1.141778152406876,  1.243162209192223,  1.340784061834245,  1.433315470058695,  1.519618350304324,  1.598819339305044,  1.670354148640186,  1.733976471809199,  1.789734571831644,
     1.837923721512030,  1.879025503659911,  1.913644390550190,  1.942449820672667,  1.966128485147401,  1.985348640682445,  2.000736025217273,  2.012859761417012,  2.022225874215904,  2.029276424454238,
     2.034392232247760,  2.037897766041106,  2.040067065766539,  2.041129971636292,  2.041278226270327,  2.040671129694777,  2.039440559201214,  2.037695421348656,  2.035525478415889,  2.033004617637087,
     2.030193595939791,  2.027142330585669,  2.023891831729497,  2.020475777000279,  2.016921820119915,  2.013252677871748,  2.009487010198497,  2.005640149647911,  2.001724701230407,  1.997751027739811,
     1.993727653302714,  1.989661591817193,  1.985558613619364,  1.981423466046174,  1.977260058627804,  1.973071613935746,  1.968860785725224,  1.964629751617137,  1.960380295557281,  1.956113881736217,
     1.951831711759221,  1.947534767965737,  1.943223849280791,  1.938899602160409,  1.934562546759138,  1.930213095529329,  1.925851579534459,  1.921478252211137,  1.917093312390161,  1.912696906734162  },
  {  1.000000000000000,  1.006601645804557,  1.013058152327230,  1.019366618738973,  1.025523869925939,  1.031526418062565,  1.037370454701448,  1.043051814560892,  1.048565972537409,  1.053908001298943,
     1.059072537095789,  1.064053751391418,  1.068845312648683,  1.073440340109566,  1.077831355800021,  1.082010232008654,  1.085968134561139,  1.089695461193984,  1.093181770475194,  1.096415707551817,
     1.099384924181296,  1.102075997555284,  1.104474337254371,  1.106564101239653,  1.108328109499584,  1.109747761416014,  1.110802966079635,  1.111472093520301,  1.111731955762404,  1.111557833871996,
     1.110923567909661,  1.109801733201965,  1.108163926326463,  1.105981196899728,  1.103224639982830,  1.099866186562068,  1.095879595141510,  1.091241638982295,  1.085933464082551,  1.079942010945474,
     1.073261411247968,  1.065894184028245,  1.057852069229506,  1.049156333961024,  1.039837447401779,  1.029934120663163,  1.019491742092181,  1.008560453578284,  0.997193026467214,  0.985442801104154,
     0.973361870051452,  0.960999630008422,  0.948401756198179,  0.935609585426677,  0.922659854299158,  0.909584716008406,  0.896411955788561,  0.883165332129268,  0.869864985044302,  0.856527867097892,
     0.843168166657057,  0.829797704268008,  0.816426291984105,  0.803062053097523,  0.789711699070522,  0.776380762897641,  0.763073801596476,  0.749794566596117,  0.736546143441540,  0.723331069470356,
     0.710151431267950,  0.697008944522759,  0.683905020685463,  0.670840820977416,  0.657817301132312,  0.644835248360880,  0.631895311226754,  0.618998024425777,  0.606143829156889,  0.593333089638850,
     0.580566106849022,  0.567843129736747,  0.555164364361477,  0.542529981474660,  0.529940122899349,  0.517394906747995,  0.504894431531174,  0.492438779396444,  0.480028019032296,  0.467662208289108,
     0.455341396168280,  0.443065624376795,  0.430834928623616,  0.418649339737335,  0.406508884613269,  0.394413586900569,  0.382363467955457,  0.370358547005561,  0.358398841987302,  0.346484369662721  }
};

double expected_sensitivities[][NUM_SPECIES][NUM_TIMEPOINTS] = {
  {
    {  0.000000000000000,  0.000200471756168,  0.000802847534525,  0.001810671527840,  0.003230292461826,  0.005071024329289,  0.007345161068132,  0.010068275897568,  0.013259229538055,  0.016940552583914,
       0.021138753044854,  0.025884581305979,  0.031213393233264,  0.037165582921406,  0.043787011238648,  0.051129445939434,  0.059251003390156,  0.068216572287924,  0.078098179163699,  0.088975211813814,
       0.100934402922067,  0.114069748967075,  0.128481335431708,  0.144273982160595,  0.161554852788570,  0.180429556046402,  0.200996229969549,  0.223337659989641,  0.247510082087647,  0.273528294766954,
       0.301346704679583,  0.330835764949984,  0.361754438037671,  0.393719968283028,  0.426178397253739,  0.458380829269753,  0.489373003755953,  0.518007780425223,  0.542991682738503,  0.562969336224337,
       0.576649890166306,  0.582959672608370,  0.581200333393899,  0.571176982094439,  0.553263130649640,  0.528382336940320,  0.497899366308950,  0.463453798854737,  0.426764969297948,  0.389453895106749,
       0.352909959075459,  0.318215931247561,  0.286128560505640,  0.257101422102025,  0.231333339085644,  0.208827064979071,  0.189447104108385,  0.172970108286100,  0.159124985523663,  0.147622587747266,
       0.138176120101569,  0.130514069413401,  0.124387577493426,  0.119573931104416,  0.115877213273228,  0.113127038767079,  0.111176911469536,  0.109901907728684,  0.109196042798366,  0.108969808648198,
       0.109147909883137,  0.109667175941327,  0.110474697819590,  0.111526236535937,  0.112784850608263,  0.114219707215023,  0.115805090730155,  0.117519562219907,  0.119345249891706,  0.121267263857697,
       0.123273197415527,  0.125352715963286,  0.127497216321069,  0.129699540667570,  0.131953733281186,  0.134254839185220,  0.136598743322834,  0.138982041526557,  0.141401926089494,  0.143856083526250,
       0.146342612576732,  0.148859960557188,  0.151406870052607,  0.153982333422920,  0.156585553228124,  0.159215914220942,  0.161872943679751,  0.164556303845862,  0.167265757363416,  0.170001161688377  },
    {  0.000000000000000,  0.006668441143641,  0.013325314201604,  0.019967940665997,  0.026593616925231,  0.033199590365904,  0.039783040176305,  0.046341052944162,  0.052870610191744,  0.059368558577861,
       0.065831582134839,  0.072256179262535,  0.078638634627499,  0.084974985113632,  0.091260984798566,  0.097492067763088,  0.103663308351784,  0.109769378758421,  0.115804501742977,  0.121762402847322,
       0.127636261826994,  0.133418664026593,  0.139101556559504,  0.144676213481853,  0.150133211886693,  0.155462428723173,  0.160653072752532,  0.165693757927078,  0.170572642381045,  0.175277654404575,
       0.179796828693333,  0.184118785861432,  0.188233379266792,  0.192132542737238,  0.195811326849077,  0.199269123262312,  0.202511002493636,  0.205549050194167,  0.208403512055156,  0.211103500696392,
       0.213686987366138,  0.216199869554992,  0.218693974393454,  0.221224095129703,  0.223844369986303,  0.226604504585267,  0.229546424558248,  0.232701878164481,  0.236091262292269,  0.239723720864346,
       0.243598289696899,  0.247705737688157,  0.252030715527770,  0.256553880437848,  0.261253771377981,  0.266108316967209,  0.271095948474952,  0.276196347756017,  0.281390891763076,  0.286662864094916,
       0.291997500141771,  0.297381921729801,  0.302805005634351,  0.308257218407143,  0.313730435370271,  0.319217760985605,  0.324713364753938,  0.330212328304702,  0.335710508257297,  0.341204416877565,
       0.346691119578622,  0.352168146662727,  0.357633417409453,  0.363085177017816,  0.368521943223180,  0.373942460967539,  0.379345664949868,  0.384730648090031,  0.390096635218277,  0.395442961185842,
       0.400769052462052,  0.406074411876854,  0.411358605997287,  0.416621254450094,  0.421862020899055,  0.427080605516253,  0.432276738904231,  0.437450177220282,  0.442600697839228,  0.447728095414845,
       0.452832178767613,  0.457912768428333,  0.462969694542777,  0.468002795019100,  0.473011914017833,  0.477996900767066,  0.482957608013747,  0.487893891623036,  0.492805609216606,  0.497692619853771  }
  },
  {
    {  0.000000000000000, -0.000200916040162, -0.000806378570220, -0.001822548433473, -0.003258373008149, -0.005125772493064, -0.007439680149447, -0.010218367736627, -0.013483470055461, -0.017260400388925,
      -0.021578688915241, -0.026472272672700, -0.031979888759374, -0.038145543443473, -0.045018976193283, -0.052656135695059, -0.061119658470380, -0.070479329294995, -0.080812481646278, -0.092204249384303,
      -0.104747566485054, -0.118543098902071, -0.133698025961089, -0.150324629489012, -0.168537790226526, -0.188450890601311, -0.210169583395996, -0.233783476144458, -0.259354302015404, -0.286900170716070,
      -0.316375495264503, -0.347646007578362, -0.380459518237863, -0.414413760763662, -0.448924940549324, -0.483202272264077, -0.516236511782535, -0.546812675140078, -0.573558796697477, -0.595034896317170,
      -0.609866605530455, -0.616906900645687, -0.615404076973641, -0.605138369842618, -0.586491961352682, -0.560430854532939, -0.528390738525775, -0.492101481317596, -0.453380740475843, -0.413945071699358,
      -0.375268089589450, -0.338500256393765, -0.304447542166468, -0.273594969766124, -0.246157432845696, -0.222141568274708, -0.201406870225225, -0.183719055588571, -0.168792600775915, -0.156322279689549,
      -0.146004888296509, -0.137553039363366, -0.130703066604825, -0.125218799685206, -0.120892315246762, -0.117542643274114, -0.115014068205787, -0.113173701254509, -0.111908708093289, -0.111123714932827,
      -0.110738415823576, -0.110685367694185, -0.110908017876258, -0.111359019202909, -0.111998774682706, -0.112794176399071, -0.113717554639947, -0.114745784116038, -0.115859530313545, -0.117042628241848,
      -0.118281551359049, -0.119564973006611, -0.120883404966175, -0.122228893602185, -0.123594759249493, -0.124975382012254, -0.126366029755358, -0.127762720747553, -0.129162102307074, -0.130561341522447,
      -0.131958035841941, -0.133350146491465, -0.134735941553076, -0.136113946628236, -0.137482902823294, -0.138841736573766, -0.140189517032053, -0.141525447700951, -0.142848829468368, -0.144159054397512  },
    {  0.000000000000000, -0.006690541946551, -0.013413014217958, -0.020163681267223, -0.026938742072514, -0.033734307589418, -0.040546380860846, -0.047370828382754, -0.054203367473011, -0.061039531597877,
      -0.067874638793092, -0.074703765524564, -0.081521714296173, -0.088322974330141, -0.095101681209743, -0.101851573750075, -0.108565947832836, -0.115237606988161, -0.121858806964260, -0.128421199393470,
      -0.134915773961992, -0.141332800345642, -0.147661773330885, -0.153891367975441, -0.160009405244667, -0.166002838586931, -0.171857776928443, -0.177559551375836, -0.183092850648939, -0.188441948574761,
      -0.193591048742540, -0.198524781833266, -0.203228882047468, -0.207691079392253, -0.211902196262225, -0.215857449772117, -0.219557882394125, -0.223011801452646, -0.226236028386109, -0.229256695994720,
      -0.232109300887481, -0.234837786056311, -0.237492501740493, -0.240127141152739, -0.242794972270090, -0.245544891492524, -0.248417915085112, -0.251444659445477, -0.254644100148364, -0.258023664652631,
      -0.261580423886933, -0.265303014990454, -0.269173887162444, -0.273171521462680, -0.277272387131992, -0.281452510820440, -0.285688629551476, -0.289958959599543, -0.294243646125579, -0.298524968658245,
      -0.302787372384695, -0.307017384486970, -0.311203462366145, -0.315335807857564, -0.319406166125067, -0.323407627526270, -0.327334447046650, -0.331181876554732, -0.334946014710566, -0.338623676583673,
      -0.342212281507897, -0.345709756757891, -0.349114454750137, -0.352425084332654, -0.355640652486347, -0.358760414861408, -0.361783835086037, -0.364710550357799, -0.367540342740576, -0.370273115386420,
      -0.372908872497049, -0.375447702714978, -0.377889765386167, -0.380235279015549, -0.382484511404086, -0.384637771514065, -0.386695402905852, -0.388657778508850, -0.390525295919732, -0.392298373113837,
      -0.393977445164117, -0.395562961588080, -0.397055384140441, -0.398455184892499, -0.399762844567953, -0.400978851397164, -0.402103699421855, -0.403137888184189, -0.404081921244451, -0.404936305942910  }
  },
  {
    {  0.000000000000000,  0.006680994572927,  0.013408167597056,  0.020228872484179,  0.027192250269927,  0.034349918090210,  0.041756595941488,  0.049470971745706,  0.057556102470142,  0.066080515851832,
       0.075119208236889,  0.084754477427516,  0.095076966939047,  0.106186934285276,  0.118195517596961,  0.131226056097505,  0.145415461554938,  0.160915610277507,  0.177894733840177,  0.196538594331731,
       0.217051288228742,  0.239655940267985,  0.264593521414371,  0.292121175970685,  0.322508583688312,  0.356031328120400,  0.392960098588400,  0.433545607918702,  0.477996344063872,  0.526447987746798,
       0.578923305600407,  0.635280803031390,  0.695152807272725,  0.757874821270514,  0.822412906896528,  0.887299068508766,  0.950591131330167,  1.009878844324247,  1.062362583879606,  1.105017750806638,
       1.134858791431038,  1.149274154812465,  1.146390930207244,  1.125391304356606,  1.086702965205244,  1.032009577829446,  0.964054299672831,  0.886299105518467,  0.802499643410513,  0.716298107097820,
       0.630901861693779,  0.548885913168660,  0.472120094432440,  0.401796110014853,  0.338519173041748,  0.282429934614793,  0.233330460545151,  0.190797820541110,  0.154277057182176,  0.123152013796138,
       0.096795572767275,  0.074602803103477,  0.056011065500091,  0.040510751170427,  0.027648978194393,  0.017028355557237,  0.008304516952620,  0.001181744335343, -0.004592445056471, -0.009232511883692,
      -0.012919820138384, -0.015807270523514, -0.018023500650303, -0.019676523060142, -0.020856894503324, -0.021640481912274, -0.022090794842637, -0.022260974444863, -0.022195482517652, -0.021931506211471,
      -0.021500156036437, -0.020927463632201, -0.020235209038395, -0.019441618069273, -0.018561958420559, -0.017609033994625, -0.016593581511467, -0.015524589557577, -0.014409581183532, -0.013254866712440,
      -0.012065749137377, -0.010846681770120, -0.009601399917033, -0.008333035461346, -0.007044214770569, -0.005737130030498, -0.004413637489347, -0.003075277151820, -0.001723358305640, -0.000358974010581  },
    {  0.000000000000000, -0.002221349977203, -0.004436077575610, -0.006643685378121, -0.008843906785465, -0.011036714849877, -0.013222324875137, -0.015401221237835, -0.017574159889841, -0.019742202875641,
      -0.021906748978115, -0.024069562355382, -0.026232810957386, -0.028399113296260, -0.030571590673413, -0.032753926311277, -0.034950429720379, -0.037166107667330, -0.039406747627627, -0.041679005180487,
      -0.043990496726624, -0.046349893075653, -0.048767017624622, -0.051252925014726, -0.053819967465711, -0.056481830983230, -0.059253513919191, -0.062151231370162, -0.065192203900448, -0.068394285477189,
      -0.071775380824700, -0.075352584730412, -0.079140987266760, -0.083152065676732, -0.087391677601898, -0.091857638572195, -0.096537017894508, -0.101403375667076, -0.106414318272658, -0.111509895384150,
      -0.116612432268161, -0.121628281876883, -0.126451844780525, -0.130971715833409, -0.135078345760966, -0.138672161864865, -0.141670879582330, -0.144014815524260, -0.145669552291859, -0.146625781281096,
      -0.146896774671101, -0.146514243430242, -0.145523445117549, -0.143978303009553, -0.141937064775724, -0.139458789703671, -0.136600744189750, -0.133416649052518, -0.129955641880868, -0.126261794681175,
      -0.122374031550318, -0.118326314298273, -0.114147989765747, -0.109864220003177, -0.105496451791647, -0.101062882930195, -0.096578889874107, -0.092057426630971, -0.087509383389477, -0.082943899966052,
      -0.078368636390708, -0.073790005933590, -0.069213376220226, -0.064643237072075, -0.060083342979845, -0.055536834165223, -0.051006336847510, -0.046494047765269, -0.042001805080477, -0.037531147286532,
      -0.033083362706079, -0.028659530588279, -0.024260555253843, -0.019887194794342, -0.015540085491209, -0.011219762110914, -0.006926674174663, -0.002661198993268,  0.001576346595721,  0.005785695564440,
       0.009966622583561,  0.014118937419698,  0.018242479382133,  0.022337112544432,  0.026402721680862,  0.030439209254427,  0.034446491319487,  0.038424496643371,  0.042373163111151,  0.046292437056924  }
  },
  {
    {  1.000000000000000,  1.001002981241415,  1.004019780529938,  1.009073835951195,  1.016204118809001,  1.025465795621023,  1.036930021016889,  1.050685267982215,  1.066837148661187,  1.085509995346001,
       1.106848010126745,  1.131016174241705,  1.158201493766102,  1.188614420039189,  1.222490034288696,  1.260089000086508,  1.301698289028614,  1.347631465371319,  1.398227942502207,  1.453850976120736,
       1.514883584966874,  1.581723960723379,  1.654772415049039,  1.734417904921635,  1.821017515116705,  1.914866391147443,  2.016155730695919,  2.124920278901417,  2.240967856487642,  2.363790691004170,
       2.492458616991985,  2.625494087477403,  2.760736377860479,  2.895207444965278,  3.025002151924526,  3.145235943824121,  3.250091608534567,  3.333014001058002,  3.387102915174931,  3.405698770259962,
       3.383154861023635,  3.315675201327004,  3.202077331860333,  3.044281631194123,  2.847370380882569,  2.619160881819268,  2.369318857407083,  2.108255212713392,  1.845993436836656,  1.591254607985340,
       1.350878694247962,  1.129610051245325,  0.930188671327135,  0.753642790973025,  0.599677098594113,  0.467070968220740,  0.354032559526382,  0.258482708234673,  0.178263918927268,  0.111281450392242,
       0.055589560992437,  0.009436520893001, -0.028718645655383, -0.060207585301391, -0.086166019976651, -0.107553985278397, -0.125175598617467, -0.139699961142857, -0.151681526243885, -0.161578090310266,
      -0.169766441741691, -0.176556002185036, -0.182200591773659, -0.186908134560933, -0.190848798652089, -0.194161839674064, -0.196961169286174, -0.199339964553619, -0.201374468451042, -0.203127073249468,
      -0.204648867708192, -0.205981703203250, -0.207159873492476, -0.208211496095098, -0.209159663387494, -0.210023378760929, -0.210818283522927, -0.211557221718095, -0.212250743322683, -0.212907556376154,
      -0.213534868084474, -0.214138642522505, -0.214723813644765, -0.215294467411589, -0.215853996350883, -0.216405204743538, -0.216950465263596, -0.217491736104581, -0.218030696700090, -0.218568757322670  },
    {  0.000000000000000, -0.006671122055216, -0.013346737749121, -0.020040351320592, -0.026765641421049, -0.033536585101358, -0.040367560533764, -0.047273478169447, -0.054269844194159, -0.061372915885584,
      -0.068599842184089, -0.075968775574332, -0.083499007720368, -0.091211131387486, -0.099127200615953, -0.107270892828864, -0.115667677715522, -0.124344990076885, -0.133332406854201, -0.142661810355295,
      -0.152367529287513, -0.162486474914104, -0.173058161455370, -0.184124688982372, -0.195730610019604, -0.207922618362262, -0.220748977192193, -0.234258680285394, -0.248500177490233, -0.263519569606836,
      -0.279358169868612, -0.296049279955875, -0.313614110909181, -0.332056761267715, -0.351358431937275, -0.371471046285869, -0.392310846631891, -0.413752762671461, -0.435626761024302, -0.457717409541363,
      -0.479768111402223, -0.501490638901709, -0.522580189995635, -0.542734662430083, -0.561675803289314, -0.579169150968093, -0.595039409409667, -0.609179118515095, -0.621549688356805, -0.632175498430989,
      -0.641132999051243, -0.648537187739293, -0.654527743960220, -0.659256525027922, -0.662877403459768, -0.665538779352604, -0.667378631372692, -0.668521709527153, -0.669078374951404, -0.669144601162583,
      -0.668802725935142, -0.668122633118436, -0.667163130421047, -0.665973369473307, -0.664594220938915, -0.663059528846145, -0.661397218525689, -0.659630276997066, -0.657777590897224, -0.655854656968374,
      -0.653874176484761, -0.651846550774120, -0.649780297257108, -0.647682386814605, -0.645558523531061, -0.643413376620714, -0.641250767385036, -0.639073823571221, -0.636885106104202, -0.634686711630528,
      -0.632480356989395, -0.630267447816647, -0.628049134487563, -0.625826358042247, -0.623599888514249, -0.621370356150756, -0.619138275768589, -0.616904065740608, -0.614668064987032, -0.612430548257260,
      -0.610191737604481, -0.607951811214495, -0.605710910692184, -0.603469147228113, -0.601226606950206, -0.598983354604370, -0.596739438887072, -0.594494893087636, -0.592249739767302, -0.590003991147619  }
  },
  {
    {  0.000000000000000,  0.060064198215322,  0.120313480376537,  0.181015742423255,  0.242443776625880,  0.304878429609210,  0.368611472170901,  0.433949112608201,  0.501213689858927,  0.570747914133305,
       0.642918573666744,  0.718119375591892,  0.796774359342626,  0.879341910924134,  0.966318364907881,  1.058241235783420,  1.155692238724416,  1.259299762871946,  1.369740007148391,  1.487736281635579,
       1.614055292473213,  1.749502660892909,  1.894905765478036,  2.051095531564509,  2.218877203663749,  2.398985838076662,  2.592022192383374,  2.798370672660554,  3.018086730728879,  3.250752025476817,
       3.495296010856599,  3.749781795727118,  4.011165996488863,  4.275049889226277,  4.535457544552137,  4.784692911295137,  5.013346191143665,  5.210534758308094,  5.364471189150594,  5.463367906845064,
       5.496687924914577,  5.456561415072525,  5.339149093115238,  5.145619495711120,  4.882457323811164,  4.560970409522952,  4.195993625514566,  3.804156971026632,  3.402014304189231,  3.004452746236786,
       2.623607044678913,  2.268358754627769,  1.944351764397436,  1.654369626874554,  1.398905876679105,  1.176783739458710,  0.985728862181628,  0.822843997388802,  0.684970022438119,  0.568939664324262,
       0.471741302180791,  0.390613182516069,  0.323088312870292,  0.267006458909250,  0.220503374327999,  0.181985908803917,  0.150106147041324,  0.123731837078025,  0.101916137413739,  0.083870376634182,
       0.068939895744973,  0.056582572457331,  0.046350053632962,  0.037872075334785,  0.030843174159924,  0.025011392697189,  0.020168997600984,  0.016144729579038,  0.012797355568836,  0.010010402424871,
       0.007687759749249,  0.005750081463402,  0.004131848544747,  0.002778932134346,  0.001646542531655,  0.000697554219473, -0.000098810235653, -0.000768015632176, -0.001331134457743, -0.001805671342192,
      -0.002206202525863, -0.002544861956312, -0.002831743808664, -0.003075249653986, -0.003282382001647, -0.003458953235709, -0.003609880928680, -0.003739231146803, -0.003850476678717, -0.003946525433401  },
    {  1.000000000000000,  0.998465882439532,  0.996532766978474,  0.994199073312562,  0.991461436464655,  0.988314605994202,  0.984751460112312,  0.980762842557626,  0.976337577946221,  0.971462276176772,
       0.966121178461759,  0.960296022500024,  0.953965855263951,  0.947106807380304,  0.939691855946220,  0.931690565655257,  0.923068813868297,  0.913788498741942,  0.903807218328052,  0.893077958860841,
       0.881548799268081,  0.869162619466118,  0.855856935027558,  0.841563807041401,  0.826209905014815,  0.809716822378814,  0.792001783747981,  0.772978775715322,  0.752560358496601,  0.730660336191677,
       0.707197477122611,  0.682100560976935,  0.655314914697803,  0.626810653192307,  0.596592398992571,  0.564710313563529,  0.531271585857987,  0.496451150765144,  0.460499709830752,  0.423746883010550,
       0.386596987887122,  0.349516016707061,  0.313009054929187,  0.277589803429512,  0.243745716098152,  0.211903728801318,  0.182402165418359,  0.155472930583456,  0.131235967989363,  0.109705475291130,
       0.090805091744890,  0.074388363098501,  0.060260728128581,  0.048200066914986,  0.037973972684812,  0.029352964686461,  0.022119670116697,  0.016074483401341,  0.011038428482995,  0.006853976685286,
       0.003384482076670,  0.000512766484864, -0.001860743486404, -0.003820050325141, -0.005435636248959, -0.006766389040135, -0.007861322772453, -0.008761129988061, -0.009499532244865, -0.010104436108557,
      -0.010598910421217, -0.011002010491443, -0.011329476682355, -0.011594306038685, -0.011807230339682, -0.011977115756386, -0.012111288018793, -0.012215802938320, -0.012295670187805, -0.012355035609527,
      -0.012397333108339, -0.012425408953021, -0.012441623347336, -0.012447934807632, -0.012445971230734, -0.012437088080111, -0.012422414255126, -0.012402888275815, -0.012379290693172, -0.012352273317329,
      -0.012322381414449, -0.012290071050351, -0.012255723537027, -0.012219657862474, -0.012182141202547, -0.012143396514364, -0.012103613120052, -0.012062948439104, -0.012021537263262, -0.011979492952202  }
  }
};

size_t lds;
double * simdata, * sensitivities;
static int init_suite() {
  lds = (num_timepoints + 1u) & ~1u;

  simdata = malloc(num_species * lds * sizeof(double));
  if (simdata == NULL)
    return -1;

  sensitivities = malloc(num_species * (num_real_params + num_species) * lds * sizeof(double));
  if (sensitivities == NULL) {
    free(simdata);
    return -1;
  }

  return 0;
}

static void init_test() {
  memset(simdata, 0, num_species * lds * sizeof(double));
  for (size_t j = 0; j < num_species; j++)
    simdata[j * lds] = ics[j];

  memset(sensitivities, 0, num_species * (num_real_params + num_species) * lds * sizeof(double));
  for (size_t j = 0; j < num_real_params * num_species; j++)
    sensitivities[j * lds] = 0.0;
}

static void init_sens_ics(size_t num_sens, const size_t * block) {
  memset(simdata, 0, num_species * lds * sizeof(double));
  memset(sensitivities, 0, num_species * (num_real_params + num_species) * lds * sizeof(double));
  const double * ics = &params[num_real_params];
  for (size_t j = 0; j < num_species; j++)
    simdata[j * lds] = ics[j];
  if (block == NULL) {
    for (size_t j = 0; j < num_sens; j++) {
      for (size_t i = 0; i < num_species; i++)
        sensitivities[(j * num_species + i) * lds] = (i == j - num_real_params) ? 1.0 : 0.0;
    }
  }
  else {
    for (size_t j = 0; j < num_sens; j++) {
      for (size_t i = 0; i < num_species; i++)
        sensitivities[(j * num_species + i) * lds] = (i == block[j] - num_real_params) ? 1.0 : 0.0;
    }
  }
}

static int cleanup_suite() {
  free(simdata);
  free(sensitivities);
  return 0;
}

static void check_simdata() {
  for (size_t j = 0; j < num_species; j++) {
    for (size_t i = 0; i < num_timepoints; i++)
      CU_ASSERT(reldif(simdata[j * lds + i], expected_simdata[j][i]) <= 1.0e-05);
  }
}

static void check_sensitivities(size_t num_sens, const size_t * block) {
  if (block == NULL) {
    for (size_t j = 0; j < num_sens; j++) {
      for (size_t k = 0; k < num_species; k++) {
        for (size_t i = 0; i < num_timepoints; i++)
          CU_ASSERT(reldif(sensitivities[(j * num_species + k) * lds + i], expected_sensitivities[j][k][i]) <= 1.0e-03);
      }
    }
  }
  else {
    for (size_t j = 0; j < num_sens; j++) {
      for (size_t k = 0; k < num_species; k++) {
        for (size_t i = 0; i < num_timepoints; i++)
          CU_ASSERT(reldif(sensitivities[(j * num_species + k) * lds + i], expected_sensitivities[block[j]][k][i]) <= 1.0e-03);
      }
    }
  }
}

static void test_no_sens() {
  init_test();
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 0, timepoints, params, NULL, &options, simdata, NULL, lds);
  CU_ASSERT(error == 0);
  check_simdata();
}

static void test_all_sens() {
  init_test();
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, num_real_params, timepoints, params, NULL, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(num_real_params, NULL);
}

static void test_block_sens0() {
  init_test();
  const size_t block[] = { 0 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 1, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(1, block);
}

static void test_block_sens1() {
  init_test();
  const size_t block[] = { 1 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 1, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(1, block);
}

static void test_block_sens2() {
  init_test();
  const size_t block[] = { 2 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 1, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(1, block);
}

static void test_block_sens01() {
  init_test();
  const size_t block[] = { 0, 1 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 2, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(2, block);
}

static void test_block_sens02() {
  init_test();
  const size_t block[] = { 0, 2 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 2, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(2, block);
}

static void test_block_sens10() {
  init_test();
  const size_t block[] = { 1, 0 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 2, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(2, block);
}

static void test_block_sens12() {
  init_test();
  const size_t block[] = { 1, 2 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 2, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(2, block);
}

static void test_block_sens20() {
  init_test();
  const size_t block[] = { 2, 0 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 2, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(2, block);
}

static void test_block_sens21() {
  init_test();
  const size_t block[] = { 2, 1 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 2, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(2, block);
}

static void test_block_sens012() {
  init_test();
  const size_t block[] = { 0, 1, 2 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 3, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(3, block);
}

static void test_block_sens021() {
  init_test();
  const size_t block[] = { 0, 2, 1 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 3, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(3, block);
}

static void test_block_sens102() {
  init_test();
  const size_t block[] = { 1, 0, 2 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 3, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(3, block);
}

static void test_block_sens120() {
  init_test();
  const size_t block[] = { 1, 2, 0 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 3, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(3, block);
}

static void test_block_sens201() {
  init_test();
  const size_t block[] = { 2, 0, 1 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 3, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(3, block);
}

static void test_block_sens210() {
  init_test();
  const size_t block[] = { 2, 1, 0 };
  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, 3, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);
  check_simdata();
  check_sensitivities(3, block);
}

static void test_all_sens_ics() {
  init_sens_ics(num_real_params + num_species, NULL);

  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, num_real_params + num_species, timepoints, params, NULL, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);

  check_simdata();
  check_sensitivities(num_real_params + num_species, NULL);
}

static void test_block_sens_ics_34() {
  const size_t num_sens = 2;
  const size_t block[] = { 3, 4 };
  init_sens_ics(num_sens, block);

  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, num_sens, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);

  check_simdata();
  check_sensitivities(num_sens, block);
}

static void test_block_sens_ics_43() {
  const size_t num_sens = 2;
  const size_t block[] = { 4, 3 };
  init_sens_ics(num_sens, block);

  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, num_sens, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);

  check_simdata();
  check_sensitivities(num_sens, block);
}

static void test_block_sens_ics_04132() {
  const size_t num_sens = 5;
  const size_t block[] = { 0, 4, 1, 3, 2 };
  init_sens_ics(num_sens, block);

  int error = cvodes_solve(rhs, num_timepoints, num_species, num_real_params, num_sens, timepoints, params, block, &options, simdata, sensitivities, lds);
  CU_ASSERT(error == 0);

  check_simdata();
  check_sensitivities(num_sens, block);
}

#define CUNIT_ERROR(message) \
  do { \
    CU_cleanup_registry(); \
    fprintf(stderr, "%s\nCUnit error code %d in %s (%s:%d): %s\n", \
                     message, CU_get_error(), __func__, __FILE__, __LINE__, \
                     CU_get_error_msg()); \
    return CU_get_error(); \
  } while (0)

#define ADD_TEST(suite, test) \
  do { \
    CU_ADD_TEST(suite, test); \
    if (CU_get_error() != CUE_SUCCESS) \
      CUNIT_ERROR("Failed to add test to suite"); \
  } while (0)

int main() {
  CU_ErrorCode error = CU_initialize_registry();
  if (error != CUE_SUCCESS)
    CUNIT_ERROR("Failed to initialise test registry");

  CU_pSuite cvodes = CU_add_suite("cvodes", init_suite, cleanup_suite);
  if (CU_get_error() != CUE_SUCCESS)
    CUNIT_ERROR("Failed to add suite to registry");

  ADD_TEST(cvodes, test_no_sens);
  ADD_TEST(cvodes, test_all_sens);
  ADD_TEST(cvodes, test_block_sens0);
  ADD_TEST(cvodes, test_block_sens1);
  ADD_TEST(cvodes, test_block_sens2);
  ADD_TEST(cvodes, test_block_sens01);
  ADD_TEST(cvodes, test_block_sens02);
  ADD_TEST(cvodes, test_block_sens10);
  ADD_TEST(cvodes, test_block_sens12);
  ADD_TEST(cvodes, test_block_sens20);
  ADD_TEST(cvodes, test_block_sens21);
  ADD_TEST(cvodes, test_block_sens012);
  ADD_TEST(cvodes, test_block_sens021);
  ADD_TEST(cvodes, test_block_sens102);
  ADD_TEST(cvodes, test_block_sens120);
  ADD_TEST(cvodes, test_block_sens201);
  ADD_TEST(cvodes, test_block_sens210);
  ADD_TEST(cvodes, test_all_sens_ics);
  ADD_TEST(cvodes, test_block_sens_ics_34);
  ADD_TEST(cvodes, test_block_sens_ics_43);
  ADD_TEST(cvodes, test_block_sens_ics_04132);

  error = CU_basic_run_tests();
  if (error != CUE_SUCCESS)
    CUNIT_ERROR("Failed to run tests");

  CU_cleanup_registry();

  return 0;
}
